// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  CHANNEL_PARTNER
  VISITOR
}

enum CPStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String? // null for OAuth users
  role          UserRole  @default(VISITOR)
  image         String?
  emailVerified DateTime?
  lastLogin     DateTime?
  city          String?
  state         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  channelPartner ChannelPartner?
  ratings        Rating[]
  activities     UserActivity[]
  pageViews      PageView[]
  trackedProperties TrackedProperty[]

  @@index([email])
  @@index([role])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  order       Int      @default(0)
  showInMenu  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subCategories SubCategory[]
  properties    Property[]

  @@index([slug])
}

model SubCategory {
  id          String   @id @default(cuid())
  name        String
  slug        String
  description String?
  order       Int      @default(0)
  categoryId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category   Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  properties Property[]

  @@unique([categoryId, slug])
  @@index([categoryId])
}

model Builder {
  id            String   @id @default(cuid())
  name          String   @unique
  logo          String?
  description   String?
  website       String?
  contactInfo   Json? // {phone, email, address}
  isSuspended   Boolean  @default(false)
  // SEO Metadata
  metaTitle     String?
  metaDescription String?  @db.Text
  metaKeywords  String?
  ogTitle       String?
  ogDescription String?  @db.Text
  ogImage       String?
  twitterCard   String? // summary, summary_large_image
  canonicalUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  properties Property[]

  @@index([name])
  @@index([isSuspended])
}

model ChannelPartner {
  id              String    @id @default(cuid())
  userId          String    @unique
  firstName       String
  lastName        String
  companyName     String?
  phone           String
  city            String
  state           String
  reraNumber      String?
  emailOTP        String?
  emailOTPExpiry  DateTime?
  emailVerified   Boolean   @default(false)
  status          CPStatus  @default(PENDING)
  approvedAt      DateTime?
  rejectedAt      DateTime?
  suspendedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
}

model Location {
  id        String   @id @default(cuid())
  name      String   @unique
  city      String?
  state     String?
  country   String   @default("India")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  properties Property[]

  @@index([name])
}

model Property {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  description   String?  @db.Text
  type          String // Flat, House, Plot, etc.
  size          String? // e.g., "1500 sqft", "3BHK"
  price         Float
  seller        String? // Only visible to admin
  isFeatured    Boolean  @default(false)
  isHidden      Boolean  @default(false)
  images        Json // Array of image URLs (stored as JSON in MySQL)
  logo          String? // Builder/Property logo
  viewCount     Int      @default(0)
  categoryId    String
  subCategoryId String?
  builderId     String
  locationId    String
  // SEO Metadata
  metaTitle     String?
  metaDescription String?  @db.Text
  metaKeywords  String?
  ogTitle       String?
  ogDescription String?  @db.Text
  ogImage       String?
  twitterCard   String? // summary, summary_large_image
  canonicalUrl  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category     Category       @relation(fields: [categoryId], references: [id])
  subCategory  SubCategory?   @relation(fields: [subCategoryId], references: [id])
  builder      Builder        @relation(fields: [builderId], references: [id])
  location     Location       @relation(fields: [locationId], references: [id])
  priceHistory PriceHistory[]
  ratings      Rating[]
  pageViews    PageView[]
  trackedProperties TrackedProperty[]

  @@index([slug])
  @@index([categoryId])
  @@index([builderId])
  @@index([locationId])
  @@index([isFeatured])
  @@index([isHidden])
}

model PriceHistory {
  id         String   @id @default(cuid())
  propertyId String
  price      Float
  change     Float? // Percentage change from previous price
  isIncrease Boolean // true if price increased
  createdAt  DateTime @default(now())

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([createdAt])
}

model Rating {
  id         String   @id @default(cuid())
  propertyId String
  userId     String
  rating     Int // 1-5 stars
  comment    String?  @db.Text
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([propertyId, userId])
  @@index([propertyId])
  @@index([userId])
}

model SliderImage {
  id        String   @id @default(cuid())
  imageUrl  String
  link      String? // Clickable link
  title     String?
  order     Int      @default(0)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
}

model PageView {
  id         String   @id @default(cuid())
  propertyId String?
  userId     String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  property Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  user     User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([propertyId])
  @@index([createdAt])
}

model UserActivity {
  id        String   @id @default(cuid())
  userId    String
  action    String // e.g., "view_property", "submit_rating"
  metadata  Json? // Additional data
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model NewsletterSubscriber {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String?
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  @@index([email])
  @@index([isActive])
}

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  subject   String
  content   String   @db.Text // HTML content
  type      String   // forgot_password, new_user, cp_activation, account_suspension, price_trends
  variables Json // Available variables like {{name}}, {{email}}, {{link}} (stored as JSON in MySQL)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([type])
}

model NewsletterTemplate {
  id        String   @id @default(cuid())
  name      String
  subject   String
  content   String   @db.Text // HTML content
  category  String? // Promotional, Updates, etc.
  variables Json // Available variables like {{name}}, {{property_name}} (stored as JSON in MySQL)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  campaigns NewsletterCampaign[]

  @@index([category])
}

model NewsletterCampaign {
  id           String    @id @default(cuid())
  templateId   String
  name         String
  subject      String
  recipients   Json // Array of email addresses or segments (stored as JSON in MySQL)
  status       String    @default("draft") // draft, scheduled, sending, sent, failed
  scheduledAt  DateTime?
  sentAt       DateTime?
  totalSent    Int       @default(0)
  totalOpened  Int       @default(0)
  totalClicked Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  template NewsletterTemplate @relation(fields: [templateId], references: [id])

  @@index([status])
  @@index([scheduledAt])
}

model Notification {
  id        String    @id @default(cuid())
  title     String
  message   String    @db.Text
  type      String // info, warning, error, success
  isRead    Boolean   @default(false)
  metadata  Json?
  createdAt DateTime  @default(now())
  readAt    DateTime?

  @@index([isRead])
  @@index([createdAt])
}

model SiteSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json // Flexible JSON value
  updatedAt DateTime @updatedAt

  @@index([key])
}

model TrackedProperty {
  id         String   @id @default(cuid())
  userId     String
  propertyId String
  createdAt  DateTime @default(now())

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  property Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([userId, propertyId])
  @@index([userId])
  @@index([propertyId])
}
